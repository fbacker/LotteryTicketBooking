<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      padding-top: 30px;
    }
    label {
      display: flex;
    }
    input[type=checkbox]{
      margin: 0px;
    }
    .line{
      height: 40px;
      -webkit-touch-callout: none; /* iOS Safari */
      -webkit-user-select: none; /* Chrome/Safari/Opera */
       -khtml-user-select: none; /* Konqueror */
         -moz-user-select: none; /* Firefox */
          -ms-user-select: none; /* Internet Explorer/Edge */
              user-select: none; /* Non-prefixed version, currently
                                    not supported by any browser */
    }
    .line span {
      font-size: 16px;
      padding-left: 5px;
    }

    .main{
      /*padding:10px;*/
    }
    .my-block{
      margin:10px;
    }
    .red {
      background-color: rgba(255,0,0,0.2);
    }
    .green {
      background-color: rgba(0,255,0,0.2);
    }
    .blue {
      background-color: rgba(0,0,255,0.2);
    }
  </style>

</head>
<body>

<form id="form">
  <div class="container-fluid">

    <h1>Jullotteri <small>Folkspels årliga supaspel</small></h1>

    <div class="row">
      <div class="col-sm-8">
        <div id="alerts"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-4">
        <p>Folkspels årliga supa-lotteri.</p>
        <p>Fyll i din folkspels epost address för att köpa lott. När du fått bekräftelse så betala in på Swish till xxx med ref xxx</p>
        <p>Kryssa i de lotter du vill köpa i de olika serie.</p>
        <ul>
          <li>Max 2st lotter i varje serie.</li>
          <li>50kr per lott</li>
          <li>Om inte betalat inom 2 dagar så tar vi bort dig.</li>
          <li>Du måste använda ditt för &amp; efternamn samt enbart använda en address.</li>
        </ul>      </div>
      <div class="col-sm-4">
        <div class="form-group">
          <label for="name">Namn</label>
          <input type="text" class="form-control" id="name" placeholder="Namn">
        </div>
        <div class="form-group">
          <label for="epost">Folkspel e-post</label>
          <input type="email" class="form-control" id="email" placeholder="E-post">
        </div>
        <p>Bryter du mot någon utav reglerna så tar IT dina pengar till sprit och du förlorar dina lotter.</p>
        <button type="submit" class="btn btn-primary">Boka lott</button>
      </div>
    </div>

    <div class="row main">
      <div class="col-sm-3 my-block red">
        <h3><small>Serie: </small>Röd<h3>
        <div id="block-red"></div>
      </div>
      <div class="col-sm-3 my-block blue">
        <h3><small>Serie: </small>Blå<h3>
        <div id="block-blue"></div>
      </div>
      <div class="col-sm-3 my-block green">
        <h3><small>Serie: </small>Grön<h3>
        <div id="block-green"></div>
      </div>
    </div>

  </div>
</form>



<script>
$(function() {

  var numOfTickets = 20;
  var bases = ["red","blue","green"];

  var updateInterval = null;
  var displayItem = "<div data-id='#ID' data-category='#CATEGORY' class='line'><label><input type='checkbox'> <span>Lott #ID</span></label></div>";

  var validateEmail = function(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(email);
  };

  var print = function(error,message){
    console.log("print",error,message);
    var type = (error) ? 'danger' : 'success';
    var message = '<div class="alert alert-'+type+' alert-dismissible" role="alert">'+
      '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
      message+
    '</div>';

    $("#alerts").append(message);
  };

  var build = function(){
    for(var i = 0; i < bases.length; i++){
      var base = $("#block-"+bases[i]);
      for(var j = 1; j <= numOfTickets; j++){
        var strItem = displayItem.concat('');
        strItem = strItem.replace(/#ID/g,j);
        strItem = strItem.replace(/#CATEGORY/g,bases[i]);
        base.append(strItem);
      }
    }
  };

  $( "#form" ).submit(function( event ) {
    event.preventDefault();

    var email = $("#email").val().toLowerCase();
    var name = $("#name").val().toLowerCase();
    if(name.length<2){
      print(true,"Du måste fylla i ett namn.");
      return;
    }
    if(!validateEmail(email)){
      print(true,"Du måste ange din folkspels epost.");
      return;
    }
    /*
    if(email.split("@")[1]!=="folkspel.se"){
      print(true,"Du måste ange din folkspels epost.");
      return;
    }
    */
    var inputs = $("#form").find('input');
    var selected = [];
    for(var i = 0; i < inputs.length; i++){
      var input = inputs[i];
      if(input.checked&&!input.disabled){
        var p = $(input).parent().parent()[0];
        selected.push({category:p.dataset.category,id:p.dataset.id});
      }
    }
    if(selected.length==0){
      print(true,"Du har inte valt några lotter.");
      return;
    }
    $.ajax
    ({
        type: "POST",
        url: '/api/add',
        dataType: 'json',
        data: JSON.stringify({name:name,email:email,selected:selected}),
        contentType: 'application/json',
    }).done(function( json ) {
      load();
      print(false,"Grattis, du har bokat lotter. Glöm inte att betala in annars tas du bort.");
    }).fail(function( jqxhr, textStatus, error ) {
        if(jqxhr.status===401){ // picked already exist
          print(true,"Du har valt lotter som redan är tagna. Försök igen.");
        }
        else if(jqxhr.status===402){ // max limit
          print(true,"Du har redan köpt max antal lotter.");
        }
        else if(jqxhr.status===403){ // category max limit
          var tout = '';
          switch(jqxhr.responseText){
            case 'red':
              tout = 'Röd';
              break;
            case 'green':
              tout = 'Grön';
              break;
            case 'blue':
              tout = 'Blå';
              break;
          }

          print(true,"Du kan inte köpa fler lotter i serie "+tout+".");
        }
        else if(jqxhr.status===404){ // category max limit
          print(true,"Du kan inte köpa lott "+jqxhr.responseText+" då du redan har köpt den i en annan serie.");
        }
        load();
    });
  });

  var update = function(data){
    for(var i = 0; i < data.length; i++){
      var item = data[i];
      var container = $("#block-"+item.category);
      var children = container.children();
      for(var j = 0; j < children.length; j++) {
        var $currentElement = $(children[j])[0];
        if($currentElement.dataset.id===item.id){
          var input = $($currentElement).find('input');
          if(input.length>0){
            $($currentElement).find('span').html(item.id +": "+item.name);
            $($currentElement).find('span').css('font-weight', '400');
            input.attr('disabled',true);
            input.css('display','none');
          }
          break;
        }
      };
    }
  };

  var load = function(){
    $.getJSON( "/api/list" )
      .done(function( json ) {
        update(json);
      })
      .fail(function( jqxhr, textStatus, error ) {
        var err = textStatus + ", " + error;
        print(true,"Kan inte läsa från servern, testa att ladda om sidan.");
    });
  };

  build();

  updateInterval = setInterval(load,10000);
  load();

});
</script>
</body>
</html>
